<?xml version="1.0" encoding="ISO-8859-1" ?>
<document>
<properties>
<title>Apache HowTo</title>
<author email="hgomez@apache.org">Henri Gomez</author>
<author email="shachor@il.ibm.com">Gal Shachor</author>
</properties>

<section name="Introduction">
<p>
This document explains how to connect Tomcat to the popular open source web server, Apache. 
There is actually to version of Apache, 1.3 and 2.0 and both could used mod_jk, the Tomcat redirector
module
</p>
<p>
This document was originally part of <b>Tomcat: A Minimalistic User's Guide</b> written by Gal Shachor, 
but has been split off for organizational reasons. 
</p>

<subsection name="Document Conventions and Assumptions">
<p>
${tomcat_home} is the root directory of tomcat. 
Your Tomcat installation should have the following subdirectories:

<ul>
<li>
${tomcat_home}\conf - Where you can place various configuration files
</li>
<li>
${tomcat_home}\webapps - Containing example applications
</li>
<li>
${tomcat_home}\bin - Where you place web server plugins
</li>
</ul>
</p>
<p>
In all the examples in this document ${tomcat_home} will be <b>c:\jakarta-tomcat</b>.
A worker is defined to be a tomcat process that accepts work from the IIS server.
</p>
</subsection>

<subsection name="Supported Configuration">
<p>
The mod_jk module was developed and tested on:
<ul>
<li>
Linux, FreeBSD, AIX, HP-UX, MacOS X, and should works on major Unixes platforms supporting Apache 1.3 and/or 2.0
</li>
<li>
WinNT4.0-i386 SP4/SP5/SP6a (should be able to work with other service packs), Win2K and WinXP and Win98
</li>
<li>
Cygwin (until you have an apache server and autoconf/automake support tools)
</li>
<li>
Netware
</li>
<li>
iSeries V5R1 and V5R2 with Apache 2.0.39. Be sure to have the latest Apache PTF installed. 
</li>
<li>
Tomcat 3.2.x, Tomcat 3.3.x, Tomcat 4.0.x, Tomcat 4.1.x and Tomcat 5
</li>
</ul>
</p>

<p>
The redirector uses <b>ajp12</b> and <b>ajp13</b> to send requests to the Tomcat containers. There is also an option to use Tomcat in process, 
more about the in-process mode can be found in the in process howto.
</p>
</subsection>

<subsection name="Who support ajp protocols ?">
<p>
The ajp12 protocol is only available in Tomcat 3.2.x and 3.3.x.
</p>

<p>
The <b>ajp12</b> has been <b>deprecated</b> with Tomcat 3.3.x and you should use instead 
<b>ajp13</b> which is the only ajp protocol known by Tomcat 4.0.x, 4.1.x and 5.
</p>

<p>
Of course Tomcat 3.2.x and 3.3.x also support ajp13 protocol.
</p>

<p>
Others servlet engines such as <b>jetty</b> have support for ajp13 protocol
</p>

</subsection>

<subsection name="How does it work ?">
<p>
In a nutshell a web server is waiting for client HTTP requests. 
When these requests arrive the server does whatever is needed to serve the 
requests by providing the necessary content.
</p>

<p>
Adding a servlet container may somewhat change this behavior. 
Now the web server needs also to perform the following:
</p>

<ul>
<li>
Load the servlet container adapter library and initialize it (prior to serving requests).
</li>
<li>
When a request arrives, it needs to check and see if a certain request belongs to a servlet, 
if so it needs to let the adapter take the request and handle it.
</li>
</ul>

<p>
The adapter on the other hand needs to know what requests it is going to serve, 
usually based on some pattern in the request URL, and to where to direct these requests.
</p>

<p>
Things are even more complex when the user wants to set a configuration that uses virtual hosts, 
or when they want multiple developers to work on the same web server 
but on different servlet container JVMs. 
We will cover these two cases in the advanced sections. 
</p>

</subsection>

</section>

<section name="Building mod_jk on Unix">
<p>
The mod_jk build use the widely used configure system.
</p>
<subsection name="Prepare your mod_jk configure from CVS">
In case you get source from CVS, ie without an existing configure script,
you should have autoconf for configuration and installation.
<p>
To create jakarta-tomcat-connectors's autoconf script, you will need libtool 1.3.3 or higher, 
and autoconf 2.13 or newer.
</p><p>
Those tools will not be required if you are just using a package downloaded from apache.org, 
they are only required for developers.
</p>
<p>
To create the configure script just type :

<screen>
<type>./buildconf.sh</type>
</screen>
</p>
</subsection>

<subsection name="Using configure to build mod_jk">
<p>Here's how to use configure to prepare mod_jk building, just type: 
<source>
./configure [autoconf arguments] [jakarta-tomcat-connectors arguments]
</source>
</p>

<p>
You could set <b>CFLAGS</b> and <b>LDFLAGS</b> to add some platform specifics:
</p>

<screen>
<type>LDFLAGS=-lc ./configure -with-apxs=/home2/local/apache/bin/apxs</type>
</screen>

<p>
If you want to build mod_jk for Apache 1.3 and 2.0, you should 
<ul>
<li>
use configure and indicate Apache 1.3 apxs location (--with-apxs)
</li>
<li>
use make
</li>
<li>
copy the mod_jk binary to the apache modules location
</li>
<li>
make clean (to remove all previously compiled modules)
</li>
<li>
use configure and indicate Apache 2.0 apxs location,
</li>
<li>
then make.
</li>
</ul>

</p>
</subsection>

<subsection name="configure arguments">
<p>
<table>
  <tr><th>Apache related parameters</th><th></th></tr>
  <tr>
  <td>--with-apxs[=FILE]</td>
  <td>FILE is the location of the apxs tool. Default is finding apxs in PATH.
It builds a shared Apache module. It detects automaticly the Apache version.
(2.0 and 1.3)</td>
  </tr>
  <tr><td>--with-apache=DIR</td>
  <td>DIR is the path where apache sources are located.
The apache sources should have been configured before configuring mod_jk.
DIR is something like: /home/apache/apache_1.3.19
It builds a static Apache module.</td>
  </tr>
  <tr><td>--enable-EAPI</td>
  <td>This parameter is needed when using Apache-1.3 and mod_ssl, otherwise you will get the error message:
"this module might crash under EAPI!" when loading mod_jk.so in httpd.
Not needed when --with-apxs has been used</td>
</tr>
</table>
<br/>
<table>
  <tr><th>JNI related parameters</th><th></th></tr>
  <tr><td>--enable-jni</td>
  <td>Build the JNI worker and so the build process will require 
some informations about your Java Environment</td>
  </tr>
  <tr><td>--with-java-home=DIR</td>
  <td>DIR is the  patch to the JDK root directory. Something like: /opt/java/jdk12</td>
  </tr>
  <tr><td>--with-os-type=SUBDIR</td><td>SUBDIR is the os-type subdirectory, 
  configure should guess it correctly.</td>
  </tr>
  <tr><td>--with-arch-type=SUBDIR</td><td>SUBDIR is the arch subdirectory, 
  configure should guess it correctly.</td>
  </tr>
  <tr><td>--with-java-platform=VAL</td><td>VAL is the Java platform 1 is 1.1.x and 2 is for 1.2 anf higher, 
  configure should guess it correctly.</td>
  </tr>
</table>
</p>
</subsection>

<subsection name="Examples of configure use">

<screen>
<note>Apache 1.3 and 2.0 build</note>
<type>./configure --with-apxs=/usr/sbin/apxs</type><br/>
<type>make</type><br/>
<type>cp ./apache-1.3/mod_jk.so /usr/lib/apache</type><br/>
<type>make clean</type><br/>
<type>./configure --with-apxs=/usr/sbin/apxs2</type><br/>
<type>make</type><br/>
<type>cp ./apache-2.0/mod_jk.so /usr/lib/apache2</type><br/>
</screen>

<screen>
<note>Apache 2.0 build with JNI support</note>
<type>./configure --with-apxs=/opt/apache2/bin/apxs \</type>
<typenext>--with-java-home=${JAVA_HOME} --with-java-platform=2 \</typenext>
<typenext>--enable-jni</typenext><br/>
</screen>

<screen>
<note>Apache 1.3 build without JNI support</note>
<type>./configure --with-apxs=/usr/sbin/apxs</type><br/>
</screen>

</subsection>

</section>

<section name="Building mod_jk for Apache on Windows NT/2K/XP">
<p>
The module was developed using Visual C++ version 6.0, so having this environment is a prerequisite 
if you want to perform a custom build.
</p>
<p>
The steps that you need to take are:
</p>
<ul>
<li>
Change directory to the apache 1.3 or apache 2.0 source directory depending on your version of Apache.
</li>
<li>
If you want to build mod_jk for Apache 1.3, set an <b>APACHE1_HOME</b> environment variable which points 
to where your Apache 1.3 is installed.
A mod_jk module for Apache 2.0 build will require <b>APACHE2_HOME</b> environment variable to be set. 
</li>
<li>
Copy mod_jk.dll to Apache's modules directory.
</li>
</ul>
<p>
An example on how to build mod_jk for Apache 1.3:
</p>
<screendos>
<notedos>Set location for Apache 1.3 sources</notedos>
<typedos>set APACHE1_HOME=c:\apache13</typedos>
<notedos>Change directory to the mod_jk module for Apache 1.3</notedos>
<typedos>cd c:\home\apache\jk\native\apache-1.3</typedos>
<notedos>Build the sources using MSDEV</notedos>
<typedos>MSDEV mod_jk.dsp /MAKE ALL</typedos>
<notedos>Copy the dll to your apache modules directory</notedos>
<typedos>cp release\mod_jk.dll c:\apache13\modules\</typedos>
</screendos>

<p>
An example on how to build mod_jk for Apache 2.0:
</p>
<screendos>
<notedos>Set location for Apache 2.0 sources</notedos>
<typedos>set APACHE2_HOME=c:\apache20</typedos>
<notedos>Change directory to the mod_jk module for Apache 2.0</notedos>
<typedos>cd c:\home\apache\jk\native\apache-2.0</typedos>
<notedos>Build the sources using MSDEV</notedos>
<typedos>MSDEV mod_jk.dsp /MAKE ALL</typedos>
<notedos>Copy the dll to your apache modules directory</notedos>
<typedos>cp release\mod_jk.dll c:\apache20\modules\</typedos>
</screendos>

<p>
If msdev is not in your path, enter the full path to msdev.exe. 
Also, ApacheCore.lib is expected to exist in the <b>${APACHEX_HOME}\src\CoreD</b> and 
<b>${APACHEX_HOME}\src\CoreR</b> directories before linking will succeed.
You will need to build enough of the Apache source to create these libraries.
This will build both release and debug versions of the redirector plug-in (mod_jk).
An alternative will be to open mod_jk.dsp in msdev and build it using the build menu.
</p>
</section>

<section name="Building mod_jk for Apache on iSeries/OS400">
<p>
Since OS400 V4R5, iSeries (AS/400) used Apache 2.0 as their primary web server, replacing the old IBM webserver.
It's now possible to build mod_jk on iSeries thanks to the help of IBM Rochester Labs who provided informations and patches
to adapt mod_jk to their Operating System.
</p>
<p>
You should have at least Apache 2.0.39 which is provided in recent PTFs, a C Compiler and IFS.
Since there's still no configure stuff on iSeries, you'll have to use the good command line or use a CL with is present 
in mod_jk source.
</p>
<ul>
<li>
Get the latest mod_jk source and untar it on a Windows or Unix boxes
</li>
<li>
Create a directory in IFS, ie /home/apache
</li>
<li>
Send the whole jk source directory to iSeries directory via FTP.
</li>
<li>
Then go to iSeries command line :
</li>
</ul>
<screen5250>
<note5250>Create mod_jk library</note5250>
<type5250>CRTLIB MOD_JK TEXT(‘Apache mod_jk tomcat connector module’)</type5250>
<note5250>Create service program source file</note5250>
<type5250>CRTSRCPF MOD_JK/QSRVSRC TEXT(‘Service program source file’)</type5250>
<note5250>Create the CL build program source file</note5250>
<type5250>CRTSRCPF FILE(MOD_JK/QCLSRC) TEXT(‘Build program source file’)</type5250>
<note5250>Edit the service program source file</note5250>
<type5250>STRSEU MOD_JK/QSRVSRC MOD_JK</type5250>
</screen5250>
<p>
In the edited file, specify that only jk_module should be exported :
<screen5250>
<type5250next> Columns   . . :    1  71     Edit                               MOD_JK/QSRVSRC </type5250next>
<type5250next> SEU==>                                                                  MOD_JK </type5250next>
<type5250next>        *************** Beginning of data ************************************* </type5250next>
<type5250next>0001.00 STRPGMEXP PGMLVL(*CURRENT)                                              </type5250next>
<type5250next>0002.00 EXPORT SYMBOL("jk_module")                                              </type5250next>
<type5250next>0003.00 ENDPGMEXP                                                               </type5250next>
<type5250next>        ****************** End of data **************************************** </type5250next>        
</screen5250>
</p>
<p>
You could start to build all the modules of mod_jk :
</p>
<screen5250>
<note5250>Copy the CL build program source from IFS</note5250>
<type5250>CPYFRMSTMF FROMSTMF('/home/apache/jk/native/apache-2.0/bldjk.qcsrc') +</type5250>
<type5250next>TOMBR('/QSYS.LIB/MOD_JK.LIB/QCLSRC.FILE/BLDJK.MBR') MBROPT(*REPLACE)</type5250next>
<note5250>Build the CL build program</note5250>
<type5250>CRTCLPGM PGM(MOD_JK/BLDJK) SRCFILE(MOD_JK/QCLSRC) TEXT('Apache mod_jk build program')</type5250>
<note5250>Launch the build</note5250>
<type5250>CALL MOD_JK/BLDJK</type5250><br/>
<note5250>If the build if successfull, copy the new mod_jk module</note5250>
<type5250>CRTDUPOBJ OBJ(MOD_JK) FROMLIB(MOD_JK) OBJTYPE(*SRVPGM) TOLIB(QHTTPSVR) NEWOBJ(QZTCJK)</type5250>
</screen5250>
<p>
Next, you should restart your Apache 2.0 server and enjoy this piece of OpenSource on iSeries.
</p>
</section>

</document>
